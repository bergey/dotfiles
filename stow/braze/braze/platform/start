#!/usr/bin/env bash

# https://cr.yp.to/daemontools/multilog.html
# 10 files each 1MB
LOG='multilog s1000000 n10'

if ! docker system info; then
    echo 'please start docker'
    exit 1
    # TODO test below
    # open -a docker
    # while ! docker system info; do
    # sleep 1
    # done
else
    docker-compose up -d
fi

# https://stackoverflow.com/questions/3004811/how-do-you-run-multiple-programs-in-parallel-from-a-bash-script
(trap 'kill 0' SIGINT;
 api/bin/rails server 2>&1 | $LOG ./api/log &
 dashboard/bin/rails server 2>&1 | $LOG ./dashboard/log-server &
 yarn --cwd dashboard start 2>&1 | $LOG ./dashboard/log-client &
 tools/whats_app/tracer.rb -p 8989 2>&1 | $LOG ./tools/whats_app/log &
 wait)
